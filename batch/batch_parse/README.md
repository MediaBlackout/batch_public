# Batch Parse Utility

This sub-package converts the **raw** output files produced by an OpenAI
**batch** job into a clean, machine-friendly JSON aggregate that is ready for
dashboards or downstream analytics.

---

## Directory Layout

```
batch/
├── output/             # Raw batch output .jsonl files
├── parsed/             # Consolidated JSON results
├── batch_parse/        # Parser module
│   ├── parse.py        # Main parsing logic & CLI entry-point
│   └── README.md       # ← This file
```

Nothing in this folder is executed automatically.  You invoke the parser when
you want to turn one **or many** batch output files into a single consolidated
JSON file.

---

## Quick Start

```bash
# Activate virtual environment (optional)
source venv/bin/activate

# Parse a single JSONL file from the project root
python batch/batch_parse/parse.py output/batch_output_YYYYMMDD_HHMMSS.jsonl -o parsed/results.json

# Parse all JSONL files in a directory (recursive)
python batch/batch_parse/parse.py output/ -o parsed/all_results.json
```

The `-o / --output` flag is optional – if omitted, the script writes
`aggregate.json` next to the working directory.

Verbose logging tells you where each record comes from and warns about lines
that could not be decoded.

---

## What the parser does

1. Opens every provided `.jsonl` file (or finds them recursively inside each
   directory argument).
2. Reads line-by-line; skips blanks.
3. Ensures the outer response has `status_code == 200`.
4. Extracts the assistant’s `message.content` field – this is a **JSON
   string** generated by the LLM.
5. Strips surrounding back-tick code fences (```json … ```), if any.
6. Converts the JSON string into a Python dict.
7. Appends a helper key `_source_custom_id` so you know which original
   `row_n` produced the record.
8. Repeats for every file, then writes the *list* of dicts to disk as
   pretty-printed JSON.

Rows that do not parse cleanly are kept with a single key `"raw_content"` so
the data is never silently lost.

---

## Automating the parse step

Schedule the parser to run automatically (e.g., via cron):

```cron
0 2 * * * cd /path/to/project && python -m batch.batch_parse.parse output/ -o parsed/last_night.json >> output/parse.log 2>&1
```

---

## Troubleshooting

* **Permission denied on output path** – Ensure the parent directory exists
  and you have write permissions, or choose a different `-o` target.
* **“Unable to parse inner JSON” warnings** – The model sometimes emits
  non-strict JSON.  The raw string will be included under `raw_content` so
  nothing is lost; check these cases manually or enhance the post-processing
  if needed.

---

Happy parsing! 🎉
